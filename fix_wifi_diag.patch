diff --git a/main/console_commands.c b/main/console_commands.c
--- a/main/console_commands.c
+++ b/main/console_commands.c
@@ -873,6 +873,6 @@
 
   RegisterCommands();
 
-  xTaskCreate(ConsoleTask, "console", 4096, NULL, 2, NULL);
+  xTaskCreate(ConsoleTask, "console", 12288, NULL, 2, NULL);
   return ESP_OK;
 }
 
diff --git a/main/diagnostics/diag_wifi.c b/main/diagnostics/diag_wifi.c
--- a/main/diagnostics/diag_wifi.c
+++ b/main/diagnostics/diag_wifi.c
@@ -1,6 +1,7 @@
 #include <stdint.h>
 #include <string.h>
+#include <stdlib.h>
 
@@ -345,15 +346,19 @@
   PrintHeapSnapshot(&ctx, "wifi_init_before", &wifi_before);
   PrintHeapSnapshot(&ctx, "wifi_init_after", &wifi_after);
 
-  wifi_ap_record_t ap_records[20];
-  memset(ap_records, 0, sizeof(ap_records));
+  wifi_ap_record_t* ap_records = NULL;
+  const size_t ap_records_capacity = 20;
   size_t ap_count = 0;
   esp_err_t scan_result = ESP_ERR_INVALID_STATE;
   if (scan) {
+    ap_records = (wifi_ap_record_t*)calloc(ap_records_capacity, sizeof(*ap_records));
+    if (ap_records == NULL) {
+      scan_result = ESP_ERR_NO_MEM;
+    }
     heap_snapshot_t scan_before = CaptureHeapSnapshot();
     DiagHeapCheck(&ctx, "pre_scan");
-    if (init_result == ESP_OK) {
-      scan_result = WifiManagerScan(ap_records, 20, &ap_count);
+    if (init_result == ESP_OK && scan_result == ESP_ERR_INVALID_STATE) {
+      scan_result = WifiManagerScan(ap_records, ap_records_capacity, &ap_count);
     }
     DiagHeapCheck(&ctx, "post_scan");
     heap_snapshot_t scan_after = CaptureHeapSnapshot();
     PrintHeapSnapshot(&ctx, "scan_before", &scan_before);
     PrintHeapSnapshot(&ctx, "scan_after", &scan_after);
 
     if (scan_result == ESP_OK) {
-      const size_t listed_count = (ap_count < (sizeof(ap_records) / sizeof(ap_records[0])))
-                                    ? ap_count
-                                    : (sizeof(ap_records) / sizeof(ap_records[0]));
+      const size_t listed_count =
+        (ap_count < ap_records_capacity) ? ap_count : ap_records_capacity;
       PrintScanResults(&ctx, ap_records, listed_count, ap_count);
     }
   }
+  if (ap_records != NULL) {
+    free(ap_records);
+    ap_records = NULL;
+  }
 
   bool connected = false;